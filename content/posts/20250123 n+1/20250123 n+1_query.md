+++
date = '2025-01-23'
draft = false
title = 'Django N+1 æŸ¥è©¢å•é¡Œ'
show_reading_time=true
featured_image = "images/retro_n+1.png"
categories = ["python"]
tags = ["python","django","å¾Œç«¯"]
toc=true
+++

### N+1æŸ¥è©¢å•é¡Œ
N+1 å•é¡Œæ˜¯åœ¨ ORMï¼ˆåŒ…æ‹¬ Django ORMï¼‰ä¸­å¸¸è¦‹çš„æ•ˆèƒ½å•é¡Œ
æŒ‡çš„æ˜¯åœ¨è™•ç†é—œè¯è³‡æ–™æ™‚ï¼Œé™¤äº†è¦åŸ·è¡Œä¸€æ¬¡ä¸»æŸ¥è©¢å¤–ï¼Œé‚„è¦ç‚ºæ¯å€‹çµæœåŸ·è¡Œè€Œå¤–æŸ¥è©¢

ä¾†èˆ‰å€‹ä¾‹å­ ! 
<!--more-->

```python 
# models.py
class Author(models.Model):
    name = models.CharField(max_length=100)

class Book(models.Model):
    title = models.CharField(max_length=100)
    author = models.ForeignKey(Author, on_delete=models.CASCADE)
```

### é€ æˆN+1çš„å¯«æ³•
```python
def bad_example(request):
    # 1 æ¬¡æŸ¥è©¢ç²å–æ‰€æœ‰æ›¸ç±
    books = Book.objects.all()

    # å°æ¯æœ¬æ›¸éƒ½éœ€è¦é¡å¤–æŸ¥è©¢ä¸€æ¬¡ä½œè€… (N æ¬¡æŸ¥è©¢)
    for book in books:
        print(book.author.name)  # é€™è£¡æœƒè§¸ç™¼é¡å¤–çš„æŸ¥è©¢

# å¦‚æœæœ‰ 100 æœ¬æ›¸ï¼Œç¸½å…±æœƒåŸ·è¡Œï¼š
# 1 æ¬¡æŸ¥è©¢æ›¸ç± + 100 æ¬¡æŸ¥è©¢ä½œè€… = 101 æ¬¡æŸ¥è©¢
```
### å¦‚ä½•è§£æ±ºï¼Ÿ

ğŸ’¾ ä½¿ç”¨`select_related`(é©ç”¨æ–¼ForeignKey)

```python
# ä¸€æ¬¡æ€§ç²å–æ›¸ç±åŠå…¶ä½œè€…è³‡æ–™
books=Book.objects.select_related('author').all()

for book in books:
    print(book.author.name) #ä¸æœƒè§¸ç™¼é¡å¤–æŸ¥è©¢
```

ğŸ’¾ ä½¿ç”¨`prefetch_related`(é©ç”¨æ–¼ManyToMany)

```python
# models.py
class Author(models.Model):
    name = models.CharField(max_length=100)

class Book(models.Model):
    title = models.CharField(max_length=100)
    authors = models.ManyToManyField(Author)
```

```python
# views.py
books = Book.objects.prefetch_related('authors').all()

for book in books:
    for author in book.authors.all():  # ä¸æœƒè§¸ç™¼é¡å¤–æŸ¥è©¢
        print(author.name)
```

### åµæ¸¬N+1å•é¡Œ
ä½¿ç”¨Django Debug Toolbar

```python
INSTALLED_APPS = [
    ...
    'debug_toolbar',
]

# æŸ¥çœ‹ SQL æŸ¥è©¢æ¬¡æ•¸å’ŒåŸ·è¡Œæ™‚é–“
```

### æœ€ä½³å¯¦è¸
1.å–„ç”¨QuerySetæ–¹æ³•

```python
# æ­£ç¢ºä½¿ç”¨
Book.objects.select_related('author')\
    .prefetch_related('categories')\
    .filter(published_date__year=2023)
```

2.é¿å…åœ¨å¾ªç’°ä¸­æŸ¥è©¢
```python
# éŒ¯èª¤
for book in books:
    author_name = book.author.name  # è§¸ç™¼æŸ¥è©¢

# æ­£ç¢º
books = Book.objects.select_related('author')
for book in books:
    author_name = book.author.name  # ä¸è§¸ç™¼æŸ¥è©¢
```

3.æ³¨æ„æŸ¥è©¢å„ªåŒ–

```python
# åªå–éœ€è¦çš„æ¬„ä½
Book.objects.only('title', 'author__name').select_related('author')

# æ’é™¤ä¸éœ€è¦çš„æ¬„ä½
Book.objects.defer('description').select_related('author')
```

N+1å•é¡Œå¦‚æœä¸è™•ç†ï¼Œæœƒå°è‡´:  
1.è³‡æ–™åº«æŸ¥è©¢æ¬¡æ•¸éå¤š  
2.æ‡‰ç”¨ç¨‹å¼æ•ˆèƒ½é™ä½  
3.è³‡æ–™åº«è² è¼‰å¢åŠ   
4.éŸ¿æ‡‰æ™‚é–“è®Šæ…¢  

